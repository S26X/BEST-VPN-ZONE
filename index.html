<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BEST VPN ZONE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --p: #6366f1; }
        * { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; box-sizing: border-box; }
        body { background: radial-gradient(circle at top right, #eef2ff 0%, #ffffff 50%, #f0f9ff 100%); min-height: 100vh; color: #1e293b; padding-bottom: 110px; overflow-x: hidden; }
        
        #loading-screen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .loader-ring { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 24px; padding: 16px; border: 1px solid rgba(255,255,255,0.8); position: relative; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.03); }
        .btn-p { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); color: #fff; width: 100%; padding: 16px; border-radius: 20px; font-weight: 800; font-size: 14px; box-shadow: 0 10px 20px -5px rgba(30,27,75,0.3); }
        .btn-reject { background: #fee2e2; color: #ef4444; width: 100%; padding: 12px; border-radius: 18px; font-weight: 700; font-size: 12px; }
        
        .acc-box { background: #f8fafc; border: 1.5px dashed #e2e8f0; border-radius: 14px; padding: 10px 14px; display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .acc-label { font-size: 9px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .acc-value { font-family: 'monospace'; font-size: 11px; font-weight: 700; color: #1e293b; }

        .adm-nav { display: flex; background: #f1f5f9; padding: 5px; border-radius: 18px; margin-bottom: 15px; gap: 4px; overflow-x: auto; }
        .adm-tab { flex: 1; min-width: 90px; padding: 12px 8px; font-size: 10px; font-weight: 800; color: #64748b; border-radius: 14px; text-align: center; white-space: nowrap; }
        .adm-tab-active { background: #fff; color: #6366f1; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(8px); z-index: 6000; display: none; align-items: flex-end; justify-content: center; }
        .sheet { background: #fff; width: 100%; max-width: 450px; border-radius: 35px 35px 0 0; padding: 30px; animation: slideUp 0.3s; max-height: 85vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .adm-mini-input { width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; font-size: 11px; font-weight: 600; outline: none; }
        .vpn-img { width: 48px; height: 48px; border-radius: 16px; object-fit: cover; background: #fff; border: 1px solid #f1f5f9; }
        .disabled-card { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #6366f1; }
        input:checked + .slider:before { transform: translateX(14px); }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader-ring"></div>
        <p class="mt-4 font-bold text-slate-400 text-sm tracking-widest animate-pulse uppercase">Best VPN Zone</p>
    </div>

    <div class="max-w-md mx-auto">
        <header class="p-6 flex justify-between items-center">
            <h1 class="font-black text-2xl tracking-tighter italic">BEST<span class="text-indigo-600">VPN-ZONE</span></h1>
            <div id="p-count-badge" class="hidden bg-rose-500 text-white text-[10px] font-black px-2 py-1 rounded-full animate-bounce">0</div>
        </header>

        <main class="p-5 space-y-5">
            <div id="user-profile-card" class="card bg-gradient-to-br from-indigo-600 to-blue-700 border-none p-7 text-white shadow-2xl shadow-indigo-200">
                <div class="flex items-center gap-5">
                    <img id="u-pic" class="w-16 h-16 rounded-[22px] border-2 border-white/30 shadow-lg" src="">
                    <div>
                        <h2 id="u-nickname" class="text-xl font-black tracking-tight">...</h2>
                        <p id="display-uid" class="text-[10px] font-bold opacity-70 tracking-widest mt-1 uppercase"></p>
                    </div>
                </div>
            </div>

            <div id="store-page" class="page-content space-y-4">
                <div id="vpn-list" class="space-y-3"></div>
            </div>

            <div id="history-page" class="page-content hidden space-y-3">
                <h3 class="font-black text-lg mb-2">My Orders</h3>
                <div id="user-orders" class="space-y-3"></div>
            </div>

            <div id="help-page" class="page-content hidden text-center card py-12">
                <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-5"><i class="fa-brands fa-telegram text-5xl text-indigo-500"></i></div>
                <h4 class="font-black text-xl">Contact Support</h4>
                <a id="support-link" href="#" target="_blank" class="btn-p block mt-8">Message Admin</a>
            </div>
        </main>

        <nav class="fixed bottom-0 w-full max-w-md bg-white/80 backdrop-blur-xl border-t h-20 flex justify-around items-center z-[1000]">
            <button onclick="nav('store', this)" class="nav-btn text-indigo-600 flex flex-col items-center gap-1 font-bold text-[10px]"><i class="fa-solid fa-store text-xl"></i>Store</button>
            <button onclick="nav('history', this)" class="nav-btn text-slate-400 flex flex-col items-center gap-1 font-bold text-[10px]"><i class="fa-solid fa-box text-xl"></i>Orders</button>
            <button onclick="nav('help', this)" class="nav-btn text-slate-400 flex flex-col items-center gap-1 font-bold text-[10px]"><i class="fa-solid fa-headset text-xl"></i>Help</button>
            <button id="admin-btn-nav" onclick="openAdmin()" class="hidden text-slate-400 flex flex-col items-center gap-1 font-bold text-[10px]"><i class="fa-solid fa-user-shield text-xl"></i>Admin</button>
        </nav>
    </div>

    <div id="admin-panel" class="fixed inset-0 bg-slate-50 z-[5000] hidden flex flex-col">
        <div class="p-6 flex justify-between items-center bg-white border-b">
            <h2 class="font-black text-xl">Admin Control</h2>
            <button onclick="closeAdmin()" class="w-10 h-10 bg-slate-100 rounded-full font-bold">&times;</button>
        </div>
        <div class="p-4 bg-white">
            <div class="adm-nav">
                <button onclick="admTab('pending', this)" class="adm-tab adm-tab-active">PENDING (<span id="p-count">0</span>)</button>
                <button onclick="admTab('stock', this)" class="adm-tab">STOCK MGMT</button>
                <button onclick="admTab('settings', this)" class="adm-tab">VPN MGMT</button>
            </div>
        </div>
        <div class="p-5 overflow-y-auto flex-1 pb-24">
            <div id="adm-pending" class="adm-content space-y-4"></div>
            <div id="adm-stock" class="adm-content hidden space-y-6">
                <div class="card space-y-3">
                    <b class="text-xs">Add to Stock</b>
                    <input type="text" id="stock-email" placeholder="Email / ID" class="adm-mini-input">
                    <input type="text" id="stock-pass" placeholder="Password" class="adm-mini-input">
                    <select id="stock-vpn-id" class="adm-mini-input"></select>
                    <button onclick="addStock()" class="btn-p py-3 text-xs">Save Stock</button>
                </div>
                <div id="stock-inventory-list" class="space-y-3"></div>
            </div>
            <div id="adm-settings" class="adm-content hidden space-y-6">
                <div class="card space-y-3">
                    <b class="text-[10px] uppercase">General Settings</b>
                    <input type="text" id="set-support-url" placeholder="Support Telegram Link" class="adm-mini-input">
                    <button onclick="saveSupport()" class="btn-p py-2 text-xs">Save Link</button>
                    <hr>
                    <div class="flex gap-2"><input type="text" id="pay-name" placeholder="Bkash" class="w-1/2 adm-mini-input"><input type="text" id="pay-num-in" placeholder="Number" class="w-1/2 adm-mini-input"></div>
                    <button onclick="addPay()" class="btn-p py-2 text-xs">Add Method</button>
                    <div id="pay-list" class="space-y-2 mt-2"></div>
                </div>
                <div class="card space-y-3">
                    <input type="text" id="v-name" placeholder="VPN Brand Name" class="adm-mini-input">
                    <button onclick="addVpn()" class="btn-p py-3 text-xs">Create VPN Brand</button>
                </div>
                <div id="adm-vpn-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <div id="plan-modal" class="modal"><div class="sheet" id="plan-content"></div></div>
    <div id="stock-select-modal" class="modal"><div class="sheet" id="stock-select-content"></div></div>
    <div id="pay-modal" class="modal">
        <div class="sheet text-center">
            <h3 class="font-black text-xl mb-6">Payment</h3>
            <div id="user-pay-options" class="grid grid-cols-2 gap-3 mb-6"></div>
            <div id="pay-details" class="hidden">
                <div class="bg-indigo-50 p-6 rounded-3xl mb-4" onclick="copyText(document.getElementById('active-num').innerText)">
                    <b id="active-num" class="text-2xl text-indigo-700"></b>
                </div>
                <b id="target-price" class="text-xl block mb-6 text-indigo-600"></b>
                <input type="text" id="trx-id" placeholder="Transaction ID" class="w-full p-4 border-2 rounded-2xl text-center uppercase mb-4 outline-none">
                <button onclick="orderNow()" class="btn-p">Confirm Order</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove, update, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZQHw4-DdUdDmJXcuK_88JrJxv35FfYeY",
            authDomain: "vpn-store-s26x.firebaseapp.com",
            databaseURL: "https://vpn-store-s26x-default-rtdb.firebaseio.com",
            projectId: "vpn-store-s26x",
            storageBucket: "vpn-store-s26x.firebasestorage.app",
            messagingSenderId: "373050662329",
            appId: "1:373050662329:web:b3d02424ef0986d6abea68"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        const UID = tg.initDataUnsafe?.user?.id || "0000";
        const UNAME = tg.initDataUnsafe?.user?.first_name || "Guest";
        const ADMINS = ["8505710811", "7940769450"];

        window.onload = () => {
            document.getElementById('u-nickname').innerText = UNAME;
            document.getElementById('display-uid').innerText = "ID: " + UID;
            document.getElementById('u-pic').src = tg.initDataUnsafe?.user?.photo_url || `https://ui-avatars.com/api/?name=${UNAME}&background=6366f1&color=fff`;
            if(ADMINS.includes(UID.toString())) document.getElementById('admin-btn-nav').classList.remove('hidden');
            sync();
            setTimeout(() => {
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 500);
            }, 1200);
        };

        function getVpnLogo(vName) { 
            const domain = vName.toLowerCase().replace(/\s/g, '') + ".com";
            return `https://www.google.com/s2/favicons?sz=128&domain=${domain}`;
        }

        function sync() {
            onValue(ref(db, 'supportUrl'), (s) => document.getElementById('support-link').href = s.val() || "#");
            
            onValue(ref(db, 'vpns'), (s) => {
                const uBox = document.getElementById('vpn-list'), aBox = document.getElementById('adm-vpn-list'), 
                      sSelect = document.getElementById('stock-vpn-id'), sInv = document.getElementById('stock-inventory-list');
                uBox.innerHTML = ''; aBox.innerHTML = ''; sSelect.innerHTML = ''; sInv.innerHTML = '';
                const d = s.val(); if(d) Object.keys(d).forEach(id => {
                    const v = d[id], count = v.stock ? Object.keys(v.stock).length : 0, isOff = v.status === "OFF";
                    const logo = getVpnLogo(v.name);

                   // স্টক থাকুক বা না থাকুক, শুধুমাত্র অ্যাডমিন সুইচ OFF থাকলে কার্ড কাজ করবে না
                   uBox.innerHTML += `<div onclick="${!isOff ? `openPlans('${id}')` : ''}" class="card flex justify-between items-center bg-white ${isOff ? 'disabled-card' : ''}">
                   <div class="flex items-center gap-4"><img src="${logo}" class="vpn-img"><b>${v.name}</b></div>
                   <span class="text-[9px] font-black px-3 py-1.5 rounded-lg ${!isOff ? 'bg-emerald-50 text-emerald-500' : 'bg-rose-50 text-rose-500'}">
                   ${isOff ? 'OFFLINE' : 'ONLINE'}
                   </span></div>`;

                    aBox.innerHTML += `<div class="card space-y-4">
                        <div class="flex justify-between items-center"><div class="flex items-center gap-2"><img src="${logo}" class="w-8 h-8 rounded-lg"><b>${v.name}</b></div>
                        <div class="flex items-center gap-3"><label class="switch"><input type="checkbox" ${!isOff?'checked':''} onchange="toggleV('${id}', this.checked)"><span class="slider"></span></label><i onclick="delV('${id}')" class="fa-solid fa-trash text-rose-300"></i></div></div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="p1n-${id}" value="${v.p1n||''}" placeholder="Plan 1" class="adm-mini-input"><input type="number" id="p1p-${id}" value="${v.p1p||''}" placeholder="Price" class="adm-mini-input">
                            <input type="text" id="p2n-${id}" value="${v.p2n||''}" placeholder="Plan 2" class="adm-mini-input"><input type="number" id="p2p-${id}" value="${v.p2p||''}" placeholder="Price" class="adm-mini-input">
                        </div><button onclick="saveV('${id}')" class="btn-p py-2.5 text-[10px]">Update Configuration</button></div>`;

                    sSelect.innerHTML += `<option value="${id}">${v.name}</option>`;
                    if(v.stock) {
                        let inv = `<div class="p-3 bg-slate-50 rounded-2xl"><b class="text-[10px] uppercase">${v.name} Stock</b><div class="mt-2 space-y-1">`;
                        Object.keys(v.stock).forEach(sk => {
                            inv += `<div class="flex justify-between text-[10px] bg-white p-2 rounded"><span>${v.stock[sk].email}</span><i onclick="delStockItem('${id}','${sk}')" class="fa-solid fa-times text-rose-400"></i></div>`;
                        });
                        sInv.innerHTML += inv + `</div></div>`;
                    }
                });
            });

            onValue(ref(db, 'orders'), (s) => {
                const aP = document.getElementById('adm-pending'), uBox = document.getElementById('user-orders');
                aP.innerHTML = ''; uBox.innerHTML = ''; let pCount = 0;
                const d = s.val(); if(d) Object.keys(d).forEach(id => {
                    const o = d[id];
                    if(o.st === "Pending") { 
                        pCount++; 
                        aP.innerHTML += `<div class="card space-y-3">
                            <div class="flex justify-between"><b>${o.user}</b> <span class="text-[10px] font-bold text-indigo-600">${o.method}: ${o.trx}</span></div>
                            <p class="text-[10px]">${o.vpn} (${o.plan}) - ${o.date || ''}</p>
                            <div class="flex gap-2">
                                <button onclick="showStockList('${id}','${o.vpn_id}')" class="btn-p py-3 text-[10px]">Deliver</button>
                                <button onclick="rejectOrder('${id}')" class="btn-reject">Reject</button>
                            </div>
                        </div>`; 
                    }
                    if(o.uid == UID) {
                        let stColor = o.st === "Approved" ? "bg-emerald-50 text-emerald-600" : (o.st === "Rejected" ? "bg-rose-50 text-rose-600" : "bg-indigo-50 text-indigo-600");
                        uBox.innerHTML += `<div class="card space-y-2">
                            <div class="flex justify-between items-start">
                                <div><b class="text-sm">${o.vpn}</b><p class="text-[9px] text-slate-400 mt-1">${o.date || ''}</p></div>
                                <span class="text-[10px] font-bold px-2 py-1 rounded ${stColor}">${o.st}</span>
                            </div>
                            ${o.email ? `
                            <div class="mt-3 space-y-2">
                                <div class="acc-box" onclick="copyText('${o.email}')">
                                    <div class="flex flex-col"><span class="acc-label">Email / ID</span><span class="acc-value">${o.email}</span></div>
                                    <i class="fa-regular fa-copy text-indigo-400 text-xs"></i>
                                </div>
                                <div class="acc-box" onclick="copyText('${o.pass}')">
                                    <div class="flex flex-col"><span class="acc-label">Password</span><span class="acc-value">${o.pass}</span></div>
                                    <i class="fa-regular fa-copy text-indigo-400 text-xs"></i>
                                </div>
                            </div>
                            ` : ''}
                            ${o.st === "Rejected" ? `<p class="text-[9px] text-rose-500 font-bold italic mt-2">Order was rejected by admin.</p>` : ''}
                        </div>`;
                    }
                });
                document.getElementById('p-count').innerText = pCount;
                document.getElementById('p-count-badge').className = pCount > 0 ? 'bg-rose-500 text-white text-[10px] font-black px-2 py-1 rounded-full' : 'hidden';
            });

            onValue(ref(db, 'payments'), (s) => {
                const uP = document.getElementById('user-pay-options'), pL = document.getElementById('pay-list');
                uP.innerHTML = ''; pL.innerHTML = '';
                const d = s.val(); if(d) Object.keys(d).forEach(id => {
                    uP.innerHTML += `<div onclick="setPay('${d[id].name}','${d[id].num}')" class="p-4 border-2 rounded-2xl text-[10px] font-black text-center uppercase">${d[id].name}</div>`;
                    pL.innerHTML += `<div class="flex justify-between text-[10px] p-2 bg-slate-50 rounded"><span>${d[id].name} (${d[id].num})</span><i onclick="delPay('${id}')" class="fa-solid fa-times"></i></div>`;
                });
            });
        }

        window.nav = (pageId, btn) => {
            // Reset all nav buttons
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('text-indigo-600');
                b.classList.add('text-slate-400');
            });
            // Highlight active button
            btn.classList.remove('text-slate-400');
            btn.classList.add('text-indigo-600');
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            // Show target page
            document.getElementById(pageId + '-page').classList.remove('hidden');
        };

        window.rejectOrder = (id) => {
            Swal.fire({
                title: 'Reject Order?',
                text: "User will see this order as rejected.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'Yes, Reject'
            }).then((result) => {
                if (result.isConfirmed) {
                    update(ref(db, `orders/${id}`), { st: "Rejected" }).then(() => Swal.fire('Rejected!','','success'));
                }
            });
        };

        window.saveV = (id) => update(ref(db,`vpns/${id}`), { 
            p1n: document.getElementById(`p1n-${id}`).value, p1p: document.getElementById(`p1p-${id}`).value,
            p2n: document.getElementById(`p2n-${id}`).value, p2p: document.getElementById(`p2p-${id}`).value
        }).then(() => Swal.fire('Updated','','success'));

        window.addStock = () => {
            const e = document.getElementById('stock-email').value, p = document.getElementById('stock-pass').value, vid = document.getElementById('stock-vpn-id').value;
            if(e && p) push(ref(db, `vpns/${vid}/stock`), { email: e, pass: p }).then(() => {
                document.getElementById('stock-email').value = ''; document.getElementById('stock-pass').value = '';
                Swal.fire({title:'Stock Added', icon:'success', toast:true, timer:1500});
            });
        };

        let curV, curPl, curPr, curVid, curMethod;
        window.openPlans = (id) => {
            get(ref(db,`vpns/${id}`)).then(s => {
                const v = s.val(); curV = v.name; curVid = id;
                let h = `<div class="flex justify-between items-center mb-6"><div class="flex items-center gap-3"><img src="${getVpnLogo(v.name)}" class="w-10 h-10 rounded-lg"><h3 class="font-black text-xl">${v.name}</h3></div><button onclick="this.closest('.modal').style.display='none'">&times;</button></div>`;
                if(v.p1n) h += `<div onclick="goPay('${v.p1n}','${v.p1p}')" class="card bg-indigo-50 mb-3 p-5 flex justify-between items-center"><span>${v.p1n}</span><b class="text-indigo-600">৳${v.p1p}</b></div>`;
                if(v.p2n) h += `<div onclick="goPay('${v.p2n}','${v.p2p}')" class="card bg-indigo-50 mb-3 p-5 flex justify-between items-center"><span>${v.p2n}</span><b class="text-indigo-600">৳${v.p2p}</b></div>`;
                document.getElementById('plan-content').innerHTML = h; document.getElementById('plan-modal').style.display = 'flex';
            });
        };

        window.goPay = (n, p) => { curPl = n; curPr = p; document.getElementById('plan-modal').style.display='none'; document.getElementById('pay-modal').style.display='flex'; document.getElementById('target-price').innerText = "Price: ৳"+p; };
        window.setPay = (n, m) => { curMethod = n; document.getElementById('active-num').innerText = m; document.getElementById('pay-details').classList.remove('hidden'); };
        
        window.orderNow = () => {
            const trx = document.getElementById('trx-id').value; if(!trx) return;
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB') + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            push(ref(db, 'orders'), { vpn: curV, vpn_id: curVid, plan: curPl, price: curPr, trx: trx.toUpperCase(), method: curMethod, uid: UID, user: UNAME, st: "Pending", date: dateStr }).then(() => {
                Swal.fire('Order Sent','','success'); document.getElementById('pay-modal').style.display = 'none';
                document.getElementById('trx-id').value = '';
            });
        };

        window.showStockList = async (orderId, vpnId) => {
            const snap = await get(ref(db, `vpns/${vpnId}/stock`));
            const content = document.getElementById('stock-select-content');
            let h = `<div class="mb-4 font-bold flex justify-between">Select Account <button onclick="this.closest('.modal').style.display='none'">&times;</button></div>`;
            if(snap.exists()) {
                Object.keys(snap.val()).forEach(sk => {
                    h += `<button class="w-full text-left p-4 bg-slate-50 mb-2 rounded-xl font-bold text-xs" onclick="approveSelected('${orderId}','${vpnId}','${sk}')">${snap.val()[sk].email}</button>`;
                });
            } else h += `<p class="text-rose-500">Stock empty!</p>`;
            content.innerHTML = h; document.getElementById('stock-select-modal').style.display = 'flex';
        };

        window.approveSelected = async (orderId, vpnId, stockKey) => {
            const snap = await get(ref(db, `vpns/${vpnId}/stock/${stockKey}`));
            update(ref(db, `orders/${orderId}`), { st: "Approved", email: snap.val().email, pass: snap.val().pass }).then(() => {
                remove(ref(db, `vpns/${vpnId}/stock/${stockKey}`));
                document.getElementById('stock-select-modal').style.display = 'none';
                Swal.fire('Delivered!','','success');
            });
        };

        window.toggleV = (id, val) => update(ref(db, `vpns/${id}`), { status: val ? "ON" : "OFF" });
        window.saveSupport = () => set(ref(db, 'supportUrl'), document.getElementById('set-support-url').value);
        window.addPay = () => { const n = document.getElementById('pay-name').value, m = document.getElementById('pay-num-in').value; if(n&&m) push(ref(db,'payments'),{name:n,num:m}); };
        window.delPay = (id) => remove(ref(db,`payments/${id}`));
        window.addVpn = () => { const n = document.getElementById('v-name').value; if(n) push(ref(db,'vpns'),{name:n, status: "ON"}); document.getElementById('v-name').value=''; };
        window.delV = (id) => remove(ref(db,`vpns/${id}`));
        window.delStockItem = (vid, skey) => remove(ref(db, `vpns/${vid}/stock/${skey}`));
        
        window.admTab = (t, btn) => {
            document.querySelectorAll('.adm-tab').forEach(b => b.classList.remove('adm-tab-active'));
            btn.classList.add('adm-tab-active');
            document.querySelectorAll('.adm-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('adm-'+t).classList.remove('hidden');
        };
        window.openAdmin = () => document.getElementById('admin-panel').classList.remove('hidden');
        window.closeAdmin = () => document.getElementById('admin-panel').classList.add('hidden');
        window.copyText = (t) => { navigator.clipboard.writeText(t); Swal.fire({title:'Copied', icon:'success', toast:true, timer:1000}); };
    </script>
</body>
</html>
